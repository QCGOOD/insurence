<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Title</title>
    <link rel="stylesheet" href="css/project.css">
    <script src="js/libs/jquery-3.0.0.min.js"></script>
    <script src="js/libs/jquery-weui.min.js"></script>
    <script src="js/libs/city-picker.js"></script>
    <script src="js/libs/vue2.0.js"></script>
    <script src="js/libs/hammer.min.js"></script>
    <script src="js/project.js"></script>
    <style>
        body{padding: 30px 20px;background-color: rgba(0, 0, 0, 0.75);}

        /* 选择城市与学校 */
        .weui_dialog_bd .weui_input{color: #333;}
        #school-picker{position: absolute;width: 100%;height: 100%;top:0;left: 0;opacity: 0;}
    </style>
</head>
<body>
<div id="app" style="display: none;">
    <!-- 选择学校 -->
    <div>
        <div class="weui_mask weui_mask_visible"></div>
        <div class="weui_dialog weui_dialog_visible " style="top:21%;">
            <div class="weui_dialog_hd" style="border-bottom: 0;">
                <div class="weui_dialog_title">选择城市与学校</div>
            </div>
            <div class="weui_dialog_bd weui_cells_access" style="padding-top: 0;">
                <div class="weui_cell">
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input " placeholder="请选择您所在城市" :value="school.address" type="text" id='city-picker' >
                    </div>
                    <div class="weui_cell_ft"></div>
                </div>

                <div class="weui_cell">
                    <div class="weui_cell_bd weui_cell_primary">
                        <input class="weui_input " placeholder="请选择学校类型" :value="school.schoolType" type="text" id='class-picker'>
                    </div>
                    <div class="weui_cell_ft"></div>
                </div>

                <div class="weui_cell">
                    <div class="weui_cell_bd weui_cell_primary" >
                        <input class="weui_input"  type="text" id="school-picker">
                        <input class="weui_input" v-model="school.schoolName" placeholder="请选择您所在学校" type="text" readonly>
                    </div>
                    <div class="weui_cell_ft"></div>
                </div>
            </div>
            <div class="weui_dialog_ft">
                <a onclick="saveSchool()" class="weui_btn_dialog primary">确定</a>
            </div>
        </div>
    </div>
</div>

<script>
    var vm = new Vue({
        el: '#app',
        data: function () {
            return {
                /* 学校信息 */
                school:{
                    address: '广东省 广州市 番禺区',
                    schoolType: '大学',
                    schoolName: '',
                    schoolId: ''
                },
                /* 学校数据列表 */
                schoolList:[]
            }
        },
        watch:{
            school: {
                handler: function () {
                    vm.querySchool();
                },
                deep:true
            }
        },
        methods: {
            /* 根据城市和学校类型查询学校数据 */
            querySchool: function () {
                if(this.school.address && this.school.schoolType){
                    var queryData = {
                        address: vm.school.address,
                        schoolType: vm.school.schoolType
                    };
                    var url =  'http://192.168.1.27:3000/getSchoolList';
                    $.post(url, queryData,function (data) {
                        data = JSON.parse(data);
                        vm.schoolList = data.schoolList;
                        initSchool(data.schoolList);
                    })
                }
            }
        },
        /* 初始化数据 */
        created: function () {
            setTimeout(function () {
                /* 选择城市 */
                $("#city-picker").cityPicker({
                    onChange: function (e) {
                        vm.school.address = e.displayValue.join(" ");
                    }
                });

                /* 选择学校类型 */
                $("#class-picker").picker({
                    title: "请选择学校类型",
                    cols: [
                        {
                            textAlign: 'center',
                            values: ['幼儿园','小学','初中','高中','大学']
                        }
                    ],
                    onChange: function (e) {
                        vm.school.schoolType = e.value.join(" ");
                    }
                });

                /* 给学校选择器绑定点击事件 */
                $("#school-picker").on('click', function () {
                    if(!vm.school.address){
                        $.toast('请先选择城市','text');
                    }else  if(!vm.school.schoolType){
                        $.toast('请选择学校类型','text');
                    }
                });
                vm.querySchool();
            },400);

            /* 从后台获取城市与学校 */
           /* $.get('./data/school.json', function (data) {
                if(data.code == 0 && data.school && data.school.schoolId){
                    vm.school = data.school;
                }
            })*/
        }
    });

    /* 学校选择器
     * @param schoolList 学校数据列表，格式(数组)schoolList:[{schoolId:'glzsdx',schoolName:'中山大学'}]
     * @return null
     * */
    function initSchool(schoolList) {
        var values = [];
        var displayValues = [];
        schoolList.forEach(function (school) {
            values.push(school.schoolId);
            displayValues.push(school.schoolName);
        });
        /* 选择学校 */
        $("#school-picker").picker({
            title: "请选择您的学校",
            cols: [
                {
                    textAlign: 'center',
                    values: values,
                    displayValues:displayValues
                }
            ],
            onChange: function (e,val,displayVal) {
                vm.querySchool();
                vm.school.schoolName = displayVal.join(',');
                vm.school.schoolId = val.join(',');
                console.log(vm.school.schoolId);
            }
        });
    }

    /* 保存学校 */
    function saveSchool() {
        var school = vm.school;
        if(!vm.school.schoolId){
            $.toast("请选择学校", "text");
            return false
        }
        // TODO:保存学校
        var url =  'http://192.168.1.27:3000/setSchool';
        $.post(url,school, function (data) {
            console.log(data);
            if(data.code == 0){
                store.setItem('school',school);
                window.location = 'index.html?schoolId='+vm.school.schoolId;
            }else{
                showInfo('保存失败！')
            }
        },'json');
    }
</script>

</body>
</html>